# RBAC 权限与角色定义
> audience: 'https://miku.day/api/v1/'

适用场景：
- 使用 Auth0 标准 RBAC（Roles + Permissions）
- 存在用户自助界面 + 管理后台
- 管理员可对所有用户执行同类操作

---

## 一、权限命名规范

统一格式：

- 自助权限：`<resource>:<action>_self`
- 管理权限：`<resource>:<action>`

示例：

- `profile:read_self`
- `profile:write`
- `security:reset_mfa`

---

## 二、权限定义（Permissions）

### 1. 用户基本信息（Profile）

#### 自助（仅自己）

- `profile:read_self`  
  查看自己的基本信息

- `profile:write_self`  
  修改自己的基本信息（不含邮箱）

- `profile:write_email_self`  
  修改自己的邮箱地址（高风险，单独权限）

#### 管理（任意用户）

- `profile:read`  
  查看任意用户基本信息

- `profile:write`  
  修改任意用户基本信息（不含邮箱）

- `profile:write_email`  
  修改任意用户邮箱地址（高风险）

---

### 2. 安全信息（Security）

#### 自助（仅自己）

- `security:read_self`  
  查看自己的安全状态（MFA/Passkey/绑定方式概览）

- `security:write_self`  
  修改普通安全设置（启停 MFA、解绑方式等）

- `security:change_password_self`  
  修改自己的密码

- `security:reset_mfa_self`  
  重置自己的 MFA

- `security:manage_passkeys_self`  
  添加 / 删除自己的 Passkeys

- `security:manage_social_links_self`  
  关联 / 解除社交账号或外部身份

#### 管理（任意用户）

- `security:read`  
  查看任意用户安全状态

- `security:write`  
  修改任意用户普通安全设置

- `security:force_password_reset`  
  强制用户下次登录重设密码（推荐方式）

- `security:set_password`  
  直接设置用户密码（极高风险，仅超管）

- `security:reset_mfa`  
  重置任意用户 MFA

- `security:manage_passkeys`  
  管理任意用户 Passkeys

- `security:manage_social_links`  
  管理任意用户身份绑定

---

### 3. 会话管理（Sessions）

#### 自助（仅自己）

- `sessions:read_self`  
  查看自己的会话列表

- `sessions:revoke_self`  
  注销自己的会话（单个或全部）

#### 管理（任意用户）

- `sessions:read`  
  查看任意用户会话

- `sessions:revoke`  
  注销任意用户会话

---

### 4. 管理界面
- `admin_ui:access`
  访问管理界面

## 三、角色定义（Roles）

---

### ✅ Role: EndUser（普通用户）

拥有所有自助权限：

- `profile:read_self`
- `profile:write_self`
- `profile:write_email_self`

- `security:read_self`
- `security:write_self`
- `security:change_password_self`
- `security:reset_mfa_self`
- `security:manage_passkeys_self`
- `security:manage_social_links_self`

- `sessions:read_self`
- `sessions:revoke_self`

说明：
- 只能管理自己的信息
- 不可操作其他用户

---

### ✅ Role: Admin（管理员）

拥有全部管理权限（以及可选自助权限）：

- `profile:read`
- `profile:write`
- `profile:write_email`

- `security:read`
- `security:write`
- `security:force_password_reset`
- `security:reset_mfa`
- `security:manage_passkeys`
- `security:manage_social_links`
- `security:set_password`

- `sessions:read`
- `sessions:revoke`

- `admin_ui:access`

说明：
- 可管理任意用户的资料、安全与会话

---

## 四、实现注意事项

### 1. API 鉴权

后端必须基于 Access Token 中的 `permissions` 做校验：

- 自助接口强制绑定 `sub`，禁止传 userId
- 管理接口必须校验对应管理权限

---

### 2. 字段级白名单

即使拥有 `profile:write`：

- 只允许修改低风险字段（昵称、头像、偏好等）
- 邮箱必须走 `profile:write_email` 专用接口

---

### 3. 高风险操作必须审计

建议记录审计日志的操作：

- 修改邮箱
- 重置 MFA
- 强制密码重置
- 设置密码
- 注销所有会话
- 解绑身份 / 删除 Passkey

---
